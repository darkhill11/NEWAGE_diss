---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(tidyverse)
library(readxl)
library(extrafont)
library(showtext)

#font_import()

loadfonts()
```


```{r}
#read gdp data from results
gdp_disag <- read_excel("report_pivot_merged.xlsx", sheet = "gdpreal_disag_yr")

```

```{r}
# Spread scenarios to be able to change them
gdp_diff <- spread(gdp_disag, key = "Scenario", value = "Value")

# Transform each scenario into the relative difference to reference scenario
gdp_diff <- gdp_diff %>% mutate(bau = (bau-ref)/ref)
gdp_diff <- gdp_diff %>% mutate(cAP = (cAP-ref)/ref)
gdp_diff <- gdp_diff %>% mutate(inv = (inv-ref)/ref)
gdp_diff <- gdp_diff %>% mutate(lab = (lab-ref)/ref)
gdp_diff <- gdp_diff %>% mutate(vat = (vat-ref)/ref)
```

```{r}
# drop non-EU regions, years after 2030 and categories that are not 'total'
gdp_diff_filter_2 <- filter(gdp_diff, grepl('DEU|EU28', Region))
gdp_diff_filter_2 <- filter(gdp_diff_filter_2, grepl('2030', Year))
gdp_diff_filter_2 <- filter(gdp_diff_filter_2, Type != 'total' & Type != 'total_no_cons_tax')

# drop ref
gdp_diff_filter_2 <- subset(gdp_diff_filter_2, select = -c(ref))

# gather scenarios
gdp_diff_filter_2 <- gather(gdp_diff_filter_2, 'bau', 'cAP', 'inv', 'vat', 'lab', key = 'Scenario', value = 'Value')

gdp_diff_filter_2[[4]] = toupper(gdp_diff_filter_2[[4]])

gdp_diff_filter_2$Scenario <- factor(gdp_diff_filter_2$Scenario, levels = c("INV",
                                "CAP",
                                "LAB",
                                "VAT",
                                "BAU"))
```

```{r}
gdp_diff_filter_2 <- gdp_diff_filter_2 %>%
  mutate(Type = str_replace(Type, "cons_gov", "Government's \nConsumption")) %>%
  mutate(Type = str_replace(Type, "cons_hh", "Households' \nConsumption")) %>%
  mutate(Type = str_replace(Type, "inv", "Investments")) %>%
  mutate(Type = str_replace(Type, "trade", "Trade")) %>%
  mutate(Region = str_replace(Region, "DEU", "Germany")) %>%
  mutate(Region = str_replace(Region, "EU28", "EU-28"))
```



```{r}
#font_import(pattern = "lmroman*")
#loadfonts()
#font_import()
loadfonts(device = "win")
windowsFonts()
```



```{r}
plot_gdp <- ggplot(data = gdp_diff_filter_2, aes(x = Scenario, y = Value))

plot_gdp +
  geom_bar(stat="identity",aes(fill = Scenario), color = "black") +
  facet_grid( Region ~ Type) + 
  scale_y_continuous(name = "Difference to reference scenario [REF]",
                     labels = scales::label_percent(accuracy = 1L), breaks = seq(-0.2, 0.15,0.05)) +
  theme_bw()+
  theme(text         = element_text(size=10, family="Palatino Linotype"),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 10),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 12),
        strip.text = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        legend.position = "bottom")
```  
  
  scale_x_continuous(name = "Difference to reference scenario [REF]",
                     labels = scales::label_percent(), breaks = seq(-0.2, 0.02,0.01))+
  labs(color = "Region",
       shape = "Region",
       fill = "Region")+
  scale_shape_manual(name = "Regions",
                     labels = c("Germany", "EU-28"),
                     values = c("Germany" = 21, "EU-28" = 21)) +
  scale_colour_manual(name = "Regions",
                     labels = c("Germany", "EU-28"),
                     values = c("red", "blue")) +
  scale_fill_manual(name = "Regions",
                     labels = c("Germany", "EU-28"),
                     values = c("yellow", "blue")) +
  theme_bw()+
  theme(text         = element_text(size=10, family="Palatino Linotype"),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title = element_text(size = 12),
        strip.text = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        legend.position = "bottom")
  
ggsave(width = 6, height = 5, filename = "gdp_dev.png")

```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
