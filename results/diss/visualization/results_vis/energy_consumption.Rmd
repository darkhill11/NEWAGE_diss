---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(tidyverse)
library(readxl)
library(extrafont)
library(showtext)

loadfonts(device = "win")
```

```{r}
#read emplyment data from results
energy_cons <- read_excel("report_pivot_merged.xlsx", sheet = "energy_cons_sec_yr")
```

```{r}
energy_cons_filter <- energy_cons %>%
  filter(Year == 2030, Sector %in% c("hh1", "hh2", "hh3", "hh4", "hh5", "sum_hh"))

energy_cons_filter <- energy_cons_filter %>%
  spread(key = "Fuel", value = "Value") %>%
  mutate(FF = oil + gas + COL + CRU) %>%
  gather("oil", "gas", "COL", "CRU", "FF", "ele", "total", key = "Fuel", value = "Value") %>%
  mutate(Fuel = str_replace(Fuel, "FF", "Fossil fuels")) %>%
  mutate(Fuel = str_replace(Fuel, "ele", "Electricity")) %>%
  mutate(Fuel = str_replace(Fuel, "total", "Total energy \nconsumption"))


```


```{r}

# Spread scenarios to be able to change them
energy_cons_diff <- spread(energy_cons_filter, key = "Scenario", value = "Value")

# Transform each scenario into the relative difference to reference scenario
energy_cons_diff <- energy_cons_diff %>% mutate(bau = (bau-ref)/ref)
energy_cons_diff <- energy_cons_diff %>% mutate(cAP = (cAP-ref)/ref)
energy_cons_diff <- energy_cons_diff %>% mutate(inv = (inv-ref)/ref)
energy_cons_diff <- energy_cons_diff %>% mutate(lab = (lab-ref)/ref)
energy_cons_diff <- energy_cons_diff %>% mutate(vat = (vat-ref)/ref)

# drop ref
energy_cons_diff <- subset(energy_cons_diff, select = -c(ref))

# gather scenarios
energy_cons_diff <- gather(energy_cons_diff, 'bau', 'cAP', 'inv', 'vat', 'lab', key = 'Scenario', value = 'Value')

# update scenario names and change order
energy_cons_diff[[5]] = toupper(energy_cons_diff[[5]])

energy_cons_diff$Scenario <- factor(energy_cons_diff$Scenario, levels = c("BAU",
                                                                            "VAT",
                                                                            "LAB",
                                                                            "CAP",
                                                                            "INV"))
```

```{r}

# Spread scenarios to be able to change them
energy_cons_abs <- spread(energy_cons_filter, key = "Scenario", value = "Value")

# Transform each scenario into the relative difference to reference scenario
energy_cons_abs <- energy_cons_abs %>% mutate(bau = (bau-ref))
energy_cons_abs <- energy_cons_abs %>% mutate(cAP = (cAP-ref))
energy_cons_abs <- energy_cons_abs %>% mutate(inv = (inv-ref))
energy_cons_abs <- energy_cons_abs %>% mutate(lab = (lab-ref))
energy_cons_abs <- energy_cons_abs %>% mutate(vat = (vat-ref))

# drop ref
energy_cons_abs <- subset(energy_cons_abs, select = -c(ref))

# gather scenarios
energy_cons_abs <- gather(energy_cons_abs, 'bau', 'cAP', 'inv', 'vat', 'lab', key = 'Scenario', value = 'Value')

# update scenario names and change order
energy_cons_abs[[5]] = toupper(energy_cons_abs[[5]])

energy_cons_abs$Scenario <- factor(energy_cons_abs$Scenario, levels = c("BAU",
                                                                            "VAT",
                                                                            "LAB",
                                                                            "CAP",
                                                                            "INV"))
```

```{r}
sel_ff <- c("Fossil fuels", "Electricity", "Total energy \nconsumption")

#sector.labs <- c("Relative energy consum")

```

```{r}
energy_plot <- ggplot(filter(energy_cons_diff, Region == "DEU",
                             Sector %in% c("sum_hh"),
                             Fuel %in% sel_ff), aes(x=Value, y=Fuel))

energy_plot +
  geom_col(aes(fill = Fuel), color = "black") +
  facet_grid(Scenario ~ Sector) +
  scale_fill_discrete(name = "Energy carrier") +
  scale_x_continuous(name = "Difference to reference scenario",
                     labels = scales::label_percent(accuracy = 1), breaks = seq(-0.6, 0.3,0.1))+
  theme_bw()+
  theme(text         = element_text(size=10, family="Palatino Linotype"),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 10),
        axis.title.x = element_text(size = 12),
        strip.text = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        strip.text.x = element_blank(),
        legend.position = "bottom")

ggsave(width = 6, height = 4, filename = "ene_cons_diff.png")

```

```{r}
energy_plot <- ggplot(filter(energy_cons_abs, Region == "DEU",
                             Sector %in% c("hh1", "hh3", "hh5"),
                             Fuel %in% sel_ff), aes(x=Value, y=Fuel))

energy_plot +
  geom_col(aes(fill = Fuel), color = "black") +
  facet_grid(Scenario ~ Sector)+
  scale_fill_discrete(name = "Energy carrier") +
  scale_x_continuous(name = "Difference to reference scenario [PJ]",
                     breaks = seq(-200, 60,50))+
  theme_bw()+
  theme(text         = element_text(size=10, family="Palatino Linotype"),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 10),
        axis.title.x = element_text(size = 12),
        strip.text = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        #strip.text.x = element_blank(),
        legend.position = "bottom")

ggsave(width = 6, height = 4, filename = "ene_cons_hh_abs.png")

```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
