---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(tidyverse)
library(readxl)
library(extrafont)
library(showtext)

#loadfonts(device = "win")

loadfonts()
```

```{r}
#read emplyment data from results
gva_real <- read_excel("report_pivot_merged.xlsx", sheet = "gva_real_yr")
```

```{r}

# Spread scenarios to be able to change them
gva_abs <- spread(gva_real, key = "Scenario", value = "Value")

gva_diff <- gva_abs

# Transform each scenario into the relative difference to reference scenario
gva_diff <- gva_diff %>% mutate(bau = (bau-ref)/ref)
gva_diff <- gva_diff %>% mutate(cAP = (cAP-ref)/ref)
gva_diff <- gva_diff %>% mutate(inv = (inv-ref)/ref)
gva_diff <- gva_diff %>% mutate(lab = (lab-ref)/ref)
gva_diff <- gva_diff %>% mutate(vat = (vat-ref)/ref)
```

```{r}
sel_reg <-  c("DEU",
              "FRA",
              "ITA",
              "POL",
              "UKI",
              "ESP",
              "BNL",
              "EUN",
              "EUS"
              )

```

```{r}
# drop non-EU regions, years after 2030 and categories that are not 'total'
gva_secs <- filter(gva_diff, grepl('DEU|EU28', Region))
gva_secs <- filter(gva_secs, grepl('2030', Year))
gva_secs <- filter(gva_secs, grepl('Energy Intensive Ind|non-Energy Intensive Ind|Other Sectors|SER', Sector))

gva_diff2 <- filter(gva_diff, grepl('2030', Year))
gva_diff2 <- filter(gva_diff2, grepl('Energy Intensive Ind|non-Energy Intensive Ind|Other Sectors|SER', Sector))

gva_abs2 <- filter(gva_abs, grepl('2030|2020', Year))
gva_abs2 <- filter(gva_abs2, grepl('Energy Intensive Ind|non-Energy Intensive Ind|Other Sectors|SER', Sector), Region%in% sel_reg)

# drop ref
gva_secs <- subset(gva_secs, select = -c(ref))
gva_diff2 <- subset(gva_diff2, select = -c(ref))

# gather scenarios
gva_secs <- gather(gva_secs, 'bau', 'cAP', 'inv', 'vat', 'lab', key = 'Scenario', value = 'Value')
gva_diff2 <- gather(gva_diff2, 'bau', 'cAP', 'inv', 'vat', 'lab', key = 'Scenario', value = 'Value')
gva_abs2 <- gather(gva_abs2, 'ref', 'bau', 'cAP', 'inv', 'vat', 'lab', key = 'Scenario', value = 'Value')

# update scenario names and change order
gva_secs[[4]] = toupper(gva_secs[[4]])
gva_diff2[[4]] = toupper(gva_diff2[[4]])
gva_abs2[[4]] = toupper(gva_abs2[[4]])

gva_secs <- gva_secs %>%
  mutate(Scenario = str_replace(Scenario, "VAT", "CON"))

gva_diff2 <- gva_diff2 %>%
  mutate(Scenario = str_replace(Scenario, "VAT", "CON"))

gva_abs2 <- gva_abs2 %>%
  mutate(Scenario = str_replace(Scenario, "VAT", "CON"))

gva_secs$Scenario <- factor(gva_secs$Scenario, levels = c("BAU",
                                                                            "CON",
                                                                            "LAB",
                                                                            "CAP",
                                                                            "INV"))

gva_diff2$Scenario <- factor(gva_diff2$Scenario, levels = c("BAU",
                                                                            "CON",
                                                                            "LAB",
                                                                            "CAP",
                                                                            "INV"))

gva_abs2$Scenario <- factor(gva_abs2$Scenario, levels = c("REF","BAU",
                                                                            "CON",
                                                                            "LAB",
                                                                            "CAP",
                                                                            "INV"))

gva_secs$Sector <- factor(gva_secs$Sector, levels = c("Energy Intensive Ind",
                                "non-Energy Intensive Ind",
                                "SER",
                                "Other Sectors"))

gva_diff2$Sector <- factor(gva_diff2$Sector, levels = c("Energy Intensive Ind",
                                "non-Energy Intensive Ind",
                                "SER",
                                "Other Sectors"))

gva_abs2$Sector <- factor(gva_abs2$Sector, levels = c("Energy Intensive Ind",
                                "non-Energy Intensive Ind",
                                "SER",
                                "Other Sectors"))
```

```{r}
gva_secs <- gva_secs %>%
  mutate(Sector = str_replace(Sector, "SER", "Services")) %>%
  mutate(Sector = str_replace(Sector, "non-Energy Intensive Ind", "Other \nIndustries")) %>%
  mutate(Sector = str_replace(Sector, "Energy Intensive Ind", "Energy Int. \nIndustries")) %>%
  mutate(Region = str_replace(Region, "DEU", "Germany")) %>%
  mutate(Region = str_replace(Region, "EU28", "EU+UK"))

gva_diff2 <- gva_diff2 %>%
  mutate(Sector = str_replace(Sector, "SER", "Services")) %>%
  mutate(Sector = str_replace(Sector, "non-Energy Intensive Ind", "Other \nIndustries")) %>%
  mutate(Sector = str_replace(Sector, "Energy Intensive Ind", "Energy Int. \nIndustries")) %>%
  mutate(Region = str_replace(Region, "DEU", "Germany")) %>%
  mutate(Region = str_replace(Region, "FRA", "France")) %>%
  mutate(Region = str_replace(Region, "ITA", "Italy")) %>%
  mutate(Region = str_replace(Region, "POL", "Poland")) %>%
  mutate(Region = str_replace(Region, "ESP", "Spain and Portugal")) %>%
  mutate(Region = str_replace(Region, "BNL", "Benelux")) %>%
  mutate(Region = str_replace(Region, "EUN", "Northern EU")) %>%
  mutate(Region = str_replace(Region, "EUS", "Central and Southeastern EU")) %>%
  mutate(Region = str_replace(Region, "UKI", "UK")) %>%
  mutate(Region = str_replace(Region, "EU28", "EU-28"))

gva_abs2 <- gva_abs2 %>%
  mutate(Sector = str_replace(Sector, "SER", "Services")) %>%
  mutate(Sector = str_replace(Sector, "non-Energy Intensive Ind", "Other \nIndustries")) %>%
  mutate(Sector = str_replace(Sector, "Energy Intensive Ind", "Energy Int. \nIndustries")) %>%
  mutate(Region = str_replace(Region, "DEU", "Germany")) %>%
  mutate(Region = str_replace(Region, "FRA", "France")) %>%
  mutate(Region = str_replace(Region, "ITA", "Italy")) %>%
  mutate(Region = str_replace(Region, "POL", "Poland")) %>%
  mutate(Region = str_replace(Region, "ESP", "Spain and Portugal")) %>%
  mutate(Region = str_replace(Region, "BNL", "Benelux")) %>%
  mutate(Region = str_replace(Region, "EUN", "Northern EU")) %>%
  mutate(Region = str_replace(Region, "EUS", "Central and Southeastern EU")) %>%
  mutate(Region = str_replace(Region, "UKI", "UK")) %>%
  mutate(Region = str_replace(Region, "EU28", "EU-28"))

gva_abs2$Region <- ordered(gva_abs2$Region, levels = c("EU-28",
                                                       "UK",
                                                       "Central and \nSoutheastern EU",
                                                       "Northern EU",
                                                       "Benelux",
                                                       "Spain and \nPortugal",
                                                       "Poland",
                                                       "Italy",
                                                       "France",
                                                       "Germany"))
                          
```

```{r}
gva_app <- gva_diff2 %>%
  pivot_wider(names_from = 'Scenario', values_from = 'Value')

write_csv(gva_app, 'gva_app.csv')
```

```{r}
gva_secs <- gva_secs %>%
  mutate(Region = str_replace(Region, "EU-28", "EU+UK"))

```


```{r}
plot_gva <- ggplot(data = gva_secs, aes(x = Scenario, y = Value))

plot_gva +
  geom_bar(stat='identity', aes(fill =  Scenario), color = "black") +
  facet_grid(Region ~ factor(Sector, levels = c("Energy Int. \nIndustries",
                                "Other \nIndustries",
                                "Services",
                                "Other Sectors"))) +
  scale_y_continuous(name = "Level of GVA compared to REF",
                     labels = scales::label_percent(accuracy = 0.1),
                     breaks = seq(-0.03, 0.01,0.01)) +
  scale_fill_brewer(palette="Set1") +
  theme_bw()+
  theme(text         = element_text(size=10, family="Palatino Linotype"),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.text.y = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.ticks.x = element_blank(), 
        strip.text = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        legend.position = "bottom")

ggsave(width = 6, height = 5, filename = "gva_secs.png")
  
```

```{r}
plot_gva2 <- ggplot(data = filter(gva_abs2, Year == 2020, Scenario == "REF", Region != "EU-28"), aes(y = Region, x = Value))

plot_gva2 +
  geom_bar(stat='identity', position = "fill", aes(fill = Sector), color = "black") +
  scale_x_continuous(name = "Share of total GVA",
                     labels = scales::label_percent(accuracy = 1)) +
  scale_fill_brewer(palette="Set1") +
  theme_bw()+
  theme(text         = element_text(size=10, family="Palatino Linotype"),
        axis.text.x = element_text(size = 12),
        axis.title.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        strip.text = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        legend.position = "bottom",
        legend.justification = "left")

ggsave(width = 7, height = 4, filename = "gva_2020.png")
```
  
  
  
  geom_point(data = filter(gva_secs, Year > 2022 & Region == "EU28"), 
             aes(fill = Region), 
             colour = "blue",
             alpha = 1, 
             size = 3, 
             shape = 21, 
             stroke =2) +
  geom_point(data = filter(gva_secs, Year > 2022 & Region == "DEU"), 
             aes(fill = Region), 
             colour = "black",
             alpha = 1, 
             size = 3, 
             stroke = 2, 
             shape =21) +
  facet_wrap(~Year, ncol =1) +
  scale_x_continuous(name = "Difference to reference scenario [REF]",
                     labels = scales::label_percent(accuracy = 1L), breaks = seq(-0.2, 0.1,0.05))+
  labs(color = "Region",
       shape = "Region",
       fill = "Region")+
  scale_shape_manual(name = "Regions",
                     labels = c("Germany", "EU-28"),
                     values = c("Germany" = 21, "EU-28" = 21)) +
  scale_colour_manual(name = "Regions",
                     labels = c("Germany", "EU-28"),
                     values = c("red", "blue")) +
  scale_fill_manual(name = "Regions",
                     labels = c("Germany", "EU-28"),
                     values = c("yellow", "blue")) +
  theme_bw()+
  theme(text         = element_text(size=10, family="Palatino Linotype"),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title = element_text(size = 12),
        strip.text = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        legend.position = "bottom")
  
ggsave(width = 6, height = 5, filename = "gva_dev.png")
```
