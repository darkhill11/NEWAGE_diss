---
title: "tax_incidence"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
library(tidyverse)
library(readxl)
library(extrafont)
library(showtext)

#loadfonts(device = "win")
loadfonts()
```

```{r}
ra_hh_par <- read_excel("report_pivot_merged.xlsx", sheet = "RA_hh_par_yr")
cons_hh <- read_excel("report_pivot_merged.xlsx", sheet = "cons_hh_accounts")

```

```{r}
ra_hh_par_filter <- ra_hh_par %>%
  filter(Sector == "net_income", Scenario != "ref", Year == 2030)

ra_hh_par_filter <- ra_hh_par_filter[-c(2)] %>% rename(ra_hh = Value)
```

```{r}
cons_hh_filter <- cons_hh %>%
  filter(Sector == "CO2_NETSr" | Sector == "CO2_inv_pay", Scenario != "ref", Year == 2030)

cons_hh_filter <- cons_hh_filter[-c(4)] %>% 
  rename(cons_hh = Value)
```

```{r}
tax_incidence <- full_join(ra_hh_par_filter, cons_hh_filter, by=c("Region", "Scenario", "Year", "HH"))

tax_incidence <- tax_incidence %>% mutate(incidence = cons_hh/ra_hh)

tax_incidence$Region <- gsub("DEU","Germany", tax_incidence$Region)
tax_incidence$Region <- gsub("FRA","France", tax_incidence$Region)
tax_incidence$Region <- gsub("ITA","Italy", tax_incidence$Region)
tax_incidence$Region <- gsub("UKI","UK", tax_incidence$Region)
tax_incidence$Region <- gsub("POL","Poland", tax_incidence$Region)
tax_incidence$Region <- gsub("ESP","Spain and \nPortugal", tax_incidence$Region)
tax_incidence$Region <- gsub("BNL","Benelux", tax_incidence$Region)
tax_incidence$Region <- gsub("EUN","Northern EU", tax_incidence$Region)
tax_incidence$Region <- gsub("EUS","Central and \nSoutheastern EU", tax_incidence$Region)
tax_incidence$Scenario <- gsub("vat","con", tax_incidence$Scenario)

tax_incidence <- tax_incidence %>% mutate_each(funs(toupper), Scenario)

tax_incidence$Scenario <- ordered(tax_incidence$Scenario, levels = c("BAU",
                            "CON",
                            "LAB",
                            "CAP",
                            "INV"))

```
```{r}
tax_app <- tax_incidence[-c(4,5,6)] %>%
  pivot_wider(names_from = 'Scenario', values_from = 'incidence')

write_csv(tax_app, 'tax_app.csv')
```


```{r}
incidence_plot_point <- ggplot(tax_incidence, aes(x=HH, y=incidence, color = Region, group = Region))

incidence_plot_point +
  geom_point() +
  geom_line()+
  facet_wrap(~Scenario, ncol = 3) +
  scale_y_continuous(name = "Share of net income used for CO2 payments",
                     labels = scales::label_percent(accuracy = 1L),
                     breaks = seq(0, 0.04,0.005))+
  scale_x_discrete(name = "Income group") +
  theme_bw()+
  theme(text         = element_text(size=10, family="Palatino Linotype"),
        axis.text.x = element_text(size = 10),
        axis.title.x = element_text(size = 12),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 12),
        strip.text = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        legend.position = "bottom")

ggsave(width = 8, height = 5, filename = "tax_point.png")
```

```{r}
incidence_plot_violin <- ggplot(tax_incidence, aes(x=Scenario, y=incidence))

incidence_plot_violin +
  geom_violin(aes(fill = Scenario)) +
  facet_wrap(~HH, ncol = 3) +
  scale_y_continuous(name = "Share of net income used for CO2 payments",
                     labels = scales::label_percent(accuracy = 0.1),
                     breaks = seq(0, 0.04,0.005))+
  scale_fill_brewer(palette="Set1") +
  theme_bw()+
  theme(text         = element_text(size=10, family="Palatino Linotype"),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 12),
        strip.text = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        legend.position = "bottom")

ggsave(width = 8, height = 5, filename = "tax_violin.png")
```